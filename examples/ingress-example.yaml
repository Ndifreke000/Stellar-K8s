---
# Example: Horizon node with Ingress and TLS via cert-manager
apiVersion: stellar.org/v1alpha1
kind: StellarNode
metadata:
  name: horizon-prod
  namespace: stellar-nodes
spec:
  nodeType: Horizon
  network: Mainnet
  version: "v21.0.0"
  replicas: 2
  
  resources:
    requests:
      cpu: "1"
      memory: "2Gi"
    limits:
      cpu: "4"
      memory: "8Gi"
  
  storage:
    storageClass: "fast-ssd"
    size: "200Gi"
  
  horizonConfig:
    databaseSecretRef: "horizon-db-credentials"
    enableIngest: true
    stellarCoreUrl: "http://stellar-core-svc:11626"
    ingestWorkers: 4
  
  # Horizontal Pod Autoscaling
  autoscaling:
    minReplicas: 2
    maxReplicas: 10
    targetCpuUtilizationPercentage: 70
    customMetrics:
      - "http_requests_per_second"
  
  # Ingress for HTTPS exposure with cert-manager
  ingress:
    className: "nginx"  # Use NGINX ingress controller
    
    hosts:
      - host: "horizon.stellar.example.com"
        paths:
          - path: "/"
            pathType: "Prefix"
      
      - host: "horizon-api.example.com"
        paths:
          - path: "/api/v1"
            pathType: "Prefix"
          - path: "/metrics"
            pathType: "Exact"
    
    # Use Let's Encrypt with cert-manager
    certManagerClusterIssuer: "letsencrypt-prod"
    
    # TLS secret name where the certificate will be stored
    tlsSecretName: "horizon-tls-cert"
    
    # Additional annotations for ingress controller
    annotations:
      cert-manager.io/issue-temporary-certificate: "true"
      nginx.ingress.kubernetes.io/rate-limit: "1000"
      nginx.ingress.kubernetes.io/ssl-redirect: "true"

---
# Example: Soroban RPC node with Ingress and mTLS setup
apiVersion: stellar.org/v1alpha1
kind: StellarNode
metadata:
  name: soroban-rpc-prod
  namespace: stellar-nodes
spec:
  nodeType: SorobanRpc
  network: Mainnet
  version: "v21.0.0"
  replicas: 3
  
  resources:
    requests:
      cpu: "2"
      memory: "4Gi"
    limits:
      cpu: "8"
      memory: "16Gi"
  
  storage:
    storageClass: "fast-ssd"
    size: "300Gi"
  
  sorobanConfig:
    stellarCoreUrl: "http://stellar-core-svc:11626"
    enablePreflight: true
    maxEventsPerRequest: 50000
  
  # Horizontal Pod Autoscaling
  autoscaling:
    minReplicas: 3
    maxReplicas: 20
    targetCpuUtilizationPercentage: 75
    behavior:
      scaleUp:
        stabilizationWindowSeconds: 30
        policies:
          - policyType: "Percent"
            value: 100
            periodSeconds: 15
      scaleDown:
        stabilizationWindowSeconds: 300
        policies:
          - policyType: "Percent"
            value: 50
            periodSeconds: 60
  
  # Ingress for HTTPS exposure
  ingress:
    className: "traefik"  # Use Traefik ingress controller
    
    hosts:
      - host: "soroban-rpc.example.com"
        paths:
          - path: "/"
            pathType: "Prefix"
    
    # Reference a namespaced cert-manager Issuer
    certManagerIssuer: "soroban-issuer"
    
    # TLS configuration
    tlsSecretName: "soroban-tls"
    
    annotations:
      traefik.ingress.kubernetes.io/router.tls.certresolver: "letsencrypt"

---
# Prerequisites: Create a cert-manager ClusterIssuer for Let's Encrypt
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: admin@stellar.example.com
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
      - http01:
          ingress:
            class: nginx

---
# Prerequisites: Create a namespaced Issuer for mTLS scenarios
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: soroban-issuer
  namespace: stellar-nodes
spec:
  ca:
    secretName: soroban-ca-key-pair

---
# Prerequisites: External database credentials secret for Horizon
apiVersion: v1
kind: Secret
metadata:
  name: horizon-db-credentials
  namespace: stellar-nodes
type: Opaque
stringData:
  DATABASE_URL: "postgresql://user:password@postgres.example.com:5432/horizon_mainnet"
